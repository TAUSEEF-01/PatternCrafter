<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ app_title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<header><h1>{{ app_title }}</h1></header>
<main>
  <section class="details">{{ details_html | safe }}</section>

  <section class="controls">
    <label for="dialogue">Dialogue ({{ input_var }}):</label>
    <textarea id="dialogue" rows="8">{{ sample_dialogue }}</textarea>
  </section>

  <section class="panel">
    <div class="intent">
      <h3>Intent</h3>
      <div id="intentRadios">
        {% for opt in intent_choices %}
          <label><input type="radio" name="intent" value="{{ opt }}"> {{ opt }}</label>
        {% endfor %}
      </div>
    </div>

    <div class="slots">
      <h3>Slot Labels</h3>
      <div id="slotButtons">
        {% for lab in entity_labels %}
          <button class="slot-btn" data-label="{{ lab }}">{{ lab }}</button>
        {% endfor %}
      </div>
      <div class="hint">Select text in the dialogue, then click a label to tag it.</div>
    </div>
  </section>

  <section>
    <h3>Preview</h3>
    <div id="preview" class="preview"></div>
  </section>

  <section class="actions">
    <button id="btnClear">Clear</button>
    <button id="btnSave">Save</button>
    <a class="secondary" href="{{ url_for('history') }}">History</a>
  </section>
</main>

<script>
let entities = [];

function escapeHtml(s){return s.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}
function cssSafe(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,'-');}

function renderPreview(){
  const txt = document.getElementById('dialogue').value;
  if (!txt){ document.getElementById('preview').innerText=''; return; }
  const sorted = [...entities].sort((a,b)=>a.start-b.start);
  let out='', idx=0;
  for (const e of sorted){
    out += escapeHtml(txt.slice(idx, e.start));
    out += `<mark class="tag tag-${cssSafe(e.label)}" title="${e.label}">${escapeHtml(txt.slice(e.start, e.end))}</mark>`;
    idx = e.end;
  }
  out += escapeHtml(txt.slice(idx));
  document.getElementById('preview').innerHTML = out.replace(/\n/g,'<br>');
}

document.getElementById('slotButtons').addEventListener('click', (e)=>{
  const b = e.target.closest('button.slot-btn');
  if(!b) return;
  const ta = document.getElementById('dialogue');
  const start = ta.selectionStart, end = ta.selectionEnd;
  if (start === end){ alert('Select some text first.'); return; }
  const label = b.dataset.label;
  const text = ta.value.slice(start, end);
  // remove overlapping spans
  entities = entities.filter(en => !(start < en.end && end > en.start));
  entities.push({start, end, text, label});
  renderPreview();
});

document.getElementById('dialogue').addEventListener('input', ()=>{ entities = []; renderPreview(); });
document.getElementById('btnClear').addEventListener('click', ()=>{ entities=[]; renderPreview(); });

document.getElementById('btnSave').addEventListener('click', async ()=>{
  const intentEl = document.querySelector('input[name=intent]:checked');
  const payload = {
    intent: intentEl ? intentEl.value : "",
    dialogue: document.getElementById('dialogue').value,
    entities
  };
  const res = await fetch('/save', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const js = await res.json();
  alert(js.ok ? 'Saved âœ…' : 'Save failed');
});

renderPreview();
</script>
</body>
</html>
